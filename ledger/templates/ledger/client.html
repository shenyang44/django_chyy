{% extends 'ledger/layout.html' %}
{% block title %}View Client Accounts{% endblock %}

{% block body %}
<div class="print-n">
    <div class='d-flex justify-content-around'>
        <form action="{% url 'ledger:show_cli' %}" method="POST" autocomplete="off">
            {% csrf_token %}
            Final View Date: <input name='date_to' type="text" id="datepicker">
            <button>Update</button>
        </form>
        <button id='printBtn' class="btn btn-secondary" type="button" onclick="window.print()">Print</button>
        <a class="btn btn-outline-primary" href="{% url 'ledger:create_acc' %}">New File</a>
        <a id='transBtn' class="btn btn-outline-secondary">View Transactions</a>
        <a id='accsBtn' class="btn btn-outline-secondary d-none">View Ledger</a>
    </div>
    <hr>
</div>
<table id='accsView' class="table print-sm">
    <colgroup>
        <col style="width: 30%;">
        <col style="width: 20%;">
        <col style="width: 20%;">
        <col style="width: 30%;">
    </colgroup>
    <thead>
        <tr style="border-bottom: 2px solid black;">
            <th colspan="4">
                <header class="fs-5 text-center mb-3">
                    MESSRS C.H.YEOH & YIEW
                </header>
                <div class="container d-flex flex-wrap">
                    <div style="width: 100%;" class="d-flex print-sm">
                        <div class="w-25">
                            Date From: &nbsp;<span class="fw-normal">01/01/2000</span> 
                        </div>
                        <div class="w-25"> 
                            Date To: &nbsp;<span class="fw-normal">{{ date_to|date:'d/m/Y' }}</span>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <th scope="col">Client/Name</th>
            <th scope="col">File Ref</th>
            <th class="text-center" scope="col">Date Range Balance</th>
            <th scope="col"></th>
        </tr>
    </thead>
    <tbody>
        {% for acc, rb in accounts_data %}
            <tr class="transRow {% if forloop.last %}border-bottom border-dark{% endif %}" data-id="{{acc.id}}">
                <a href="{% url 'ledger:show_acc' acc.id %}" id = a{{acc.id}} class="hidden-links"></a>
                <td class="refCell">
                    <div>
                        {{acc.client_code}}
                    </div>
                    <div>
                        {{acc.name|upper}}
                    </div>
                </td>
                <td>{{acc.file_no}}</td>
                <td class="text-end">
                    <br>
                    {{rb}}
                </td>
                {% if forloop.last %}
                    <td></td>
                {% endif %}
            </tr>
          
        {% endfor %}
        <tr class="border-bottom border-dark fw-bold">
            <td>
                Total Clients: {{file_count}}
            </td>
            <td class="text-end">
                Grand Total:
            </td>
            <td class="text-end">
                {{total}}
            </td>
            <td></td>
        </tr>
    </tbody>
</table>
<div id='transView' class="d-none">
    <table class="table print-sm">
        <colgroup>
            <col style="width: 10%;">
            <col style="width:10%;">
            <col style="width: 5%;">
            <col style="width: 40%;">
            <col style="width:10%">
            <col style="width: 10%;">
            <col style="width: 15%;">
        </colgroup>
        <thead>
            <tr style="border:none">
                <th colspan="7">
                    <header class="fs-5 text-center mb-3">
                        <div>MESSRS C.H.YEOH & YIEW</div>
                        <div>Transaction History</div>
                    </header>
                    <div style="width: 100%;" class="d-flex print-sm">
                        <div class="w-25">
                            Date From: &nbsp;<span class="fw-normal">{{date_from}}</span> 
                        </div>
                        <div class="w-25"> 
                            Date To: &nbsp;<span class="fw-normal">{{date_to}}</span>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <th scope="col">Ref No</th>
                <th scope="col">Date</th>
                <th scope="col">Type</th>
                <th scope="col">Description</th>
                <th class="text-center" scope="col">Debit</th>
                <th class="text-center" scope="col">Credit</th>
                <th class="text-center" scope="col">Balance</th>
            </tr>
        </thead>
        <tbody>
        {% for trans, entries, rb in trans_zipped %}
            {% for entry in entries %}
                <tr class="transRow" data-id="{{trans.id}}">
                    {% if account == trans.payee %}
                        <a href="{% url 'ledger:voucher' trans.id %}" id = a{{trans.id}} class="hidden-links"></a>
                        <td class="refCell">
                            {% if forloop.first %}
                            PV{{trans.id|stringformat:"05d"}}
                            {% endif %}
                        </td>
                    {% else %}
                        <a href="{% url 'ledger:receipt' trans.id %}" id = a{{trans.id}} class="hidden-links"></a>
                        <td class="refCell">
                            {% if forloop.first %}
                            RC{{trans.id|stringformat:"05d"}}
                            {% endif %}
                        </td>
                    {% endif %}
                    <td>
                        {% if forloop.first %}{{trans.created_at|date:"d/m/Y"}}{% endif %}</td>
                    <td>{{entry.type_code}}</td>
                    <td>
                        <div class="d-flex justify-content-between">
                            {{entry.description}}
                        </div>
                    </td>
                    <td class="text-center">{% if trans.payee.file_no == account.file_no %}{{entry.amount}} {% endif %}</td>
                    <td class="text-center">{% if trans.receiver.file_no == account.file_no %}{{entry.amount}}{% endif %}</td>
                    <td class="text-center">{% if forloop.last %}{{rb}}{% endif %}</td>
                </tr>
            {% endfor %}
        {% endfor %}
        </tbody>
    </table>
    <footer class="print-n text-center">
        Current balance : RM {{balance}}
    </footer>
</div>

<script charset="utf-8">
    $(()=>{
        $('.transRow').dblclick((e)=>{
            id = $(e.currentTarget).attr('data-id');
            $(`#a${id}`)[0].click()
        })
        $( "#datepicker" ).datepicker({
        changeMonth: true,
        changeYear: true,
        dateFormat: 'dd/mm/yy'
        });

        // declaring variables for display management.
        tBtn = $('#transBtn');
        aBtn = $('#accsBtn');
        tView = $('#transView');
        aView = $('#accsView');
        
        tBtn.click((e)=>{
            aView.addClass('d-none');
            tBtn.addClass('d-none');
            tView.removeClass('d-none');
            aBtn.removeClass('d-none');
        })
        aBtn.click((e)=>{
            aBtn.addClass('d-none');
            tView.addClass('d-none');
            tBtn.removeClass('d-none');
            aView.removeClass('d-none');
           
        })
    })
</script>
{% endblock %}